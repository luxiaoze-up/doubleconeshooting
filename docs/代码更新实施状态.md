# åŒé”¥é¡¹ç›®ä»£ç æ›´æ–°å®æ–½çŠ¶æ€

**æ›´æ–°æ—¥æœŸ**: 2025å¹´12æœˆ23æ—¥  
**åŸºäºæ–‡æ¡£**: `docs/åŒé”¥é¡¹ç›®æµ‹è¯•æ•°æ®æ”¶é›†.pdf`

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. è¿åŠ¨æ§åˆ¶å™¨IPåœ°å€æ›´æ–°
**çŠ¶æ€**: âœ… å·²å®Œæˆ

**ä¿®æ”¹æ–‡ä»¶**: 
- `config/devices_config.json`

**å˜æ›´è¯¦æƒ…**:
```
æ§åˆ¶å™¨1: 192.168.1.11 - å…­è‡ªç”±åº¦(AXIS 0-5) + å¤§è¡Œç¨‹(AXIS 6)
æ§åˆ¶å™¨2: 192.168.1.12 - åå°„å…‰æˆåƒ(AXIS 0-5)
æ§åˆ¶å™¨3: 192.168.1.13 - è¾…åŠ©æ”¯æ’‘(AXIS 0-4)
```

---

### 2. ç”µæœºç»†åˆ†æ•°ç»Ÿä¸€ä¸º 12800
**çŠ¶æ€**: âœ… å·²å®Œæˆ

**ä¿®æ”¹æ–‡ä»¶**:
- `config/devices_config.json` - æ‰€æœ‰è®¾å¤‡é…ç½®
- `src/device_services/six_dof_device.cpp` - é»˜è®¤å€¼ 12800
- `src/device_services/large_stroke_device.cpp` - é»˜è®¤å€¼ 12800
- `src/device_services/auxiliary_support_device.cpp` - é»˜è®¤å€¼ 12800
- `src/device_services/reflection_imaging_device.cpp` - é»˜è®¤å€¼ 12800

**å½±å“è®¾å¤‡**:
- å…­è‡ªç”±åº¦ 6è½´: 25600 â†’ 12800
- å¤§è¡Œç¨‹ 1è½´: 4000 â†’ 12800  
- åå°„å…‰æˆåƒ 6è½´: 4000 â†’ 12800
- è¾…åŠ©æ”¯æ’‘ 5è½´: 4000 â†’ 12800

---

### 3. å¤´æ–‡ä»¶æ‰©å±• - ç”µæºæ§åˆ¶å­—æ®µ
**çŠ¶æ€**: âœ… å·²å®Œæˆ

**ä¿®æ”¹æ–‡ä»¶**:
- `include/device_services/six_dof_device.h` - æ·»åŠ é©±åŠ¨å™¨/åˆ¹è½¦æ§åˆ¶å­—æ®µ
- `include/device_services/large_stroke_device.h` - æ·»åŠ é©±åŠ¨å™¨/åˆ¹è½¦æ§åˆ¶å­—æ®µ
- `include/device_services/auxiliary_support_device.h` - æ·»åŠ é©±åŠ¨å™¨æ§åˆ¶å­—æ®µ
- `include/device_services/reflection_imaging_device.h` - æ·»åŠ é©±åŠ¨å™¨æ§åˆ¶å­—æ®µ

**æ–°å¢æˆå‘˜å˜é‡**:
```cpp
// å…­è‡ªç”±åº¦ & å¤§è¡Œç¨‹ (æœ‰åˆ¹è½¦)
short driver_power_port_;            // é©±åŠ¨å™¨ä¸Šç”µç«¯å£
std::string driver_power_controller_; // æ§åˆ¶å™¨åç§°
short brake_power_port_;             // åˆ¹è½¦ä¾›ç”µç«¯å£
std::string brake_power_controller_;  // åˆ¹è½¦æ§åˆ¶å™¨åç§°
bool driver_power_enabled_;          // ç”µæºçŠ¶æ€
bool brake_released_;                // åˆ¹è½¦çŠ¶æ€

// è¾…åŠ©æ”¯æ’‘ & åå°„å…‰æˆåƒ (æ— åˆ¹è½¦)
short driver_power_port_;
std::string driver_power_controller_;
bool driver_power_enabled_;
```

---

### 4. é…ç½®æ–‡ä»¶ - ç”µæºæ§åˆ¶ç«¯å£é…ç½®
**çŠ¶æ€**: âœ… å·²å®Œæˆ

**`config/devices_config.json` æ–°å¢å­—æ®µ**:
```json
// å…­è‡ªç”±åº¦
"driverPowerPort": "0",
"driverPowerController": "sys/motion/1",
"brakePowerPort": "3",
"brakePowerController": "sys/motion/1"

// å¤§è¡Œç¨‹
"driverPowerPort": "0",
"driverPowerController": "sys/motion/1",
"brakePowerPort": "4",
"brakePowerController": "sys/motion/1"

// åå°„å…‰æˆåƒ
"driverPowerPort": "5",
"driverPowerController": "sys/motion/1"

// è¾…åŠ©æ”¯æ’‘ 1-5
"driverPowerPort": "6",
"driverPowerController": "sys/motion/1"
```

---

## âš ï¸ å¾…å®ç°çš„åŠŸèƒ½

### 5. é©±åŠ¨å™¨ä¸Šç”µæ§åˆ¶å®ç°
**çŠ¶æ€**: âš ï¸ å¾…å®ç°

**éœ€è¦æ·»åŠ çš„ä»£ç ä½ç½®**:
1. **è¯»å–é…ç½®** - åœ¨å„è®¾å¤‡çš„ `init_device()` ä¸­è¯»å– `driverPowerPort` å’Œ `driverPowerController`
2. **å®ç°æ–¹æ³•** - åœ¨å„è®¾å¤‡å®ç°æ–‡ä»¶ä¸­æ·»åŠ :
   ```cpp
   bool enable_driver_power();   // å¯åŠ¨é©±åŠ¨å™¨ç”µæº
   bool disable_driver_power();  // å…³é—­é©±åŠ¨å™¨ç”µæº
   ```
3. **è‡ªåŠ¨ä¸Šç”µ** - åœ¨ `connect_proxies()` æˆåŠŸåè‡ªåŠ¨è°ƒç”¨ `enable_driver_power()`
4. **æ–­ç”µæ§åˆ¶** - åœ¨ `delete_device()` æˆ–å¼‚å¸¸æƒ…å†µä¸‹è°ƒç”¨ `disable_driver_power()`

**å®ç°é€»è¾‘**:
```cpp
bool SixDofDevice::enable_driver_power() {
    if (sim_mode_) return true;
    if (driver_power_controller_.empty()) return true;
    
    try {
        Tango::DeviceProxy *power_ctrl = new Tango::DeviceProxy(driver_power_controller_);
        Tango::DevVarDoubleArray params;
        params.length(2);
        params[0] = driver_power_port_;  // ç«¯å£å·
        params[1] = 1;                   // HIGH = ä¸Šç”µ
        Tango::DeviceData data;
        data << params;
        power_ctrl->command_inout("writeIO", data);
        driver_power_enabled_ = true;
        INFO_STREAM << "Driver power enabled on port " << driver_power_port_ << std::endl;
        delete power_ctrl;
        return true;
    } catch (Tango::DevFailed &e) {
        ERROR_STREAM << "Failed to enable driver power: " << e.errors[0].desc << std::endl;
        return false;
    }
}
```

---

### 6. åˆ¹è½¦æ§åˆ¶å®ç°
**çŠ¶æ€**: âš ï¸ å¾…å®ç°

**éœ€è¦æ·»åŠ çš„ä»£ç ä½ç½®**:
1. **è¯»å–é…ç½®** - åœ¨å…­è‡ªç”±åº¦å’Œå¤§è¡Œç¨‹çš„ `init_device()` ä¸­è¯»å– `brakePowerPort` å’Œ `brakePowerController`
2. **å®ç°æ–¹æ³•**:
   ```cpp
   bool release_brake();  // é‡Šæ”¾åˆ¹è½¦ (OUT = HIGH)
   bool engage_brake();   // å¯ç”¨åˆ¹è½¦ (OUT = LOW)
   ```
3. **è‡ªåŠ¨æ§åˆ¶**:
   - è¿åŠ¨å‰è°ƒç”¨ `release_brake()`
   - åœæ­¢åè°ƒç”¨ `engage_brake()`
   - æ–­ç”µå‰è°ƒç”¨ `engage_brake()` ç¡®ä¿å®‰å…¨

**å®ç°é€»è¾‘**:
```cpp
bool SixDofDevice::release_brake() {
    if (sim_mode_) return true;
    if (brake_power_controller_.empty()) return true;
    
    try {
        Tango::DeviceProxy *brake_ctrl = new Tango::DeviceProxy(brake_power_controller_);
        Tango::DevVarDoubleArray params;
        params.length(2);
        params[0] = brake_power_port_;
        params[1] = 1;  // HIGH = é‡Šæ”¾åˆ¹è½¦
        Tango::DeviceData data;
        data << params;
        brake_ctrl->command_inout("writeIO", data);
        brake_released_ = true;
        INFO_STREAM << "Brake released on port " << brake_power_port_ << std::endl;
        delete brake_ctrl;
        return true;
    } catch (Tango::DevFailed &e) {
        ERROR_STREAM << "Failed to release brake: " << e.errors[0].desc << std::endl;
        return false;
    }
}
```

---

### 7. ç›¸æœºä¸Šç”µæ§åˆ¶
**çŠ¶æ€**: â“ å¾…ç¡®è®¤éœ€æ±‚

**é—®é¢˜**:
- æµ‹è¯•æ•°æ®è¡¨æ ¼ä¸­**æœªæ˜ç¡®**ç›¸æœºä¸Šç”µæ§åˆ¶ä¿¡å·
- å¯èƒ½é€šè¿‡ç‹¬ç«‹ç”µæºä¾›ç”µï¼Œä¸éœ€è¦è½¯ä»¶æ§åˆ¶
- æˆ–è€…é€šè¿‡è¿åŠ¨æ§åˆ¶å™¨çš„å…¶ä»–OUTç«¯å£æ§åˆ¶

**å»ºè®®**:
- ä¸ç¡¬ä»¶å·¥ç¨‹å¸ˆç¡®è®¤ç›¸æœºä¾›ç”µæ–¹å¼
- å¦‚æœéœ€è¦è½¯ä»¶æ§åˆ¶ï¼Œå‚ç…§é©±åŠ¨å™¨ä¸Šç”µé€»è¾‘å®ç°

---

## ğŸ”§ å®æ–½æ­¥éª¤å»ºè®®

### Step 1: å®ç°å±æ€§è¯»å–
åœ¨å„è®¾å¤‡çš„ `init_device()` ä¸­æ·»åŠ Propertyè¯»å–ä»£ç :

```cpp
db_data.push_back(Tango::DbDatum("driverPowerPort"));
db_data.push_back(Tango::DbDatum("driverPowerController"));
db_data.push_back(Tango::DbDatum("brakePowerPort"));       // ä»…å…­è‡ªç”±åº¦/å¤§è¡Œç¨‹
db_data.push_back(Tango::DbDatum("brakePowerController"));  // ä»…å…­è‡ªç”±åº¦/å¤§è¡Œç¨‹
```

### Step 2: å®ç°ç”µæºæ§åˆ¶æ–¹æ³•
åœ¨å„è®¾å¤‡å®ç°æ–‡ä»¶ä¸­æ·»åŠ  `enable_driver_power()` ç­‰æ–¹æ³•ã€‚

### Step 3: é›†æˆåˆ°åˆå§‹åŒ–æµç¨‹
åœ¨ `connect_proxies()` æˆåŠŸåè°ƒç”¨:
```cpp
if (enable_driver_power()) {
    if (release_brake()) {  // ä»…æœ‰åˆ¹è½¦çš„è®¾å¤‡
        INFO_STREAM << "Device ready for operation" << std::endl;
    }
}
```

### Step 4: é›†æˆåˆ°è¿åŠ¨æ§åˆ¶æµç¨‹
- **è¿åŠ¨å‰**: è‡ªåŠ¨æ£€æŸ¥ `brake_released_` çŠ¶æ€
- **è¿åŠ¨å**: å¯é€‰è°ƒç”¨ `engage_brake()` é”å®šç”µæœº
- **å¼‚å¸¸å¤„ç†**: é”™è¯¯æ—¶è‡ªåŠ¨å¯ç”¨åˆ¹è½¦ä¿æŠ¤

### Step 5: æµ‹è¯•éªŒè¯
1. å¯åŠ¨è®¾å¤‡ï¼ŒéªŒè¯ OUT ç«¯å£è¾“å‡ºæ­£ç¡®
2. æµ‹è¯•è¿åŠ¨æµç¨‹ï¼Œç¡®è®¤åˆ¹è½¦é‡Šæ”¾/é”å®šæ—¶åº
3. æµ‹è¯•å¼‚å¸¸æƒ…å†µä¸‹çš„å®‰å…¨ä¿æŠ¤

---

## ğŸ“Š ä¿®æ”¹æ–‡ä»¶æ¸…å•

### é…ç½®æ–‡ä»¶
- âœ… `config/devices_config.json`
- âœ… `docs/ç¡¬ä»¶é…ç½®æ›´æ–°è¯´æ˜_20251223.md` (æ–°å¢)
- âœ… `docs/ä»£ç æ›´æ–°å®æ–½çŠ¶æ€.md` (æ–°å¢)

### å¤´æ–‡ä»¶ (å·²ä¿®æ”¹)
- âœ… `include/device_services/six_dof_device.h`
- âœ… `include/device_services/large_stroke_device.h`
- âœ… `include/device_services/auxiliary_support_device.h`
- âœ… `include/device_services/reflection_imaging_device.h`

### å®ç°æ–‡ä»¶ (éƒ¨åˆ†ä¿®æ”¹)
- âœ… `src/device_services/six_dof_device.cpp` (ç»†åˆ†æ•°å·²æ›´æ–°)
- âœ… `src/device_services/large_stroke_device.cpp` (ç»†åˆ†æ•°/IPå·²æ›´æ–°)
- âœ… `src/device_services/auxiliary_support_device.cpp` (ç»†åˆ†æ•°/IPå·²æ›´æ–°)
- âœ… `src/device_services/reflection_imaging_device.cpp` (ç»†åˆ†æ•°å·²æ›´æ–°)

### å¾…æ·»åŠ ä»£ç 
- âš ï¸ å„è®¾å¤‡å®ç°æ–‡ä»¶éœ€è¦æ·»åŠ :
  - Property è¯»å–ä»£ç  (driverPowerPortç­‰)
  - ç”µæºæ§åˆ¶æ–¹æ³•å®ç°
  - åˆå§‹åŒ–æµç¨‹ä¸­çš„è‡ªåŠ¨ä¸Šç”µé€»è¾‘

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**: IPåœ°å€ã€ç»†åˆ†æ•°ã€é…ç½®æ–‡ä»¶æ›´æ–°
2. âœ… **å·²å®Œæˆ**: å¤´æ–‡ä»¶æ‰©å±•å’Œå­—æ®µå®šä¹‰
3. âš ï¸ **è¿›è¡Œä¸­**: å®ç°ç”µæºæ§åˆ¶é€»è¾‘
4. â“ **å¾…ç¡®è®¤**: ç›¸æœºä¸Šç”µéœ€æ±‚
5. ğŸ”œ **å¾…æµ‹è¯•**: ç°åœºç¡¬ä»¶æµ‹è¯•éªŒè¯

---

**ç»´æŠ¤è€…**: ç³»ç»Ÿé›†æˆå›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-12-23

