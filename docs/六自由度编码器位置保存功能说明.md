# 六自由度编码器位置保存功能说明

## 功能概述

新增的 `saveEncoderPositions` 命令可以将六自由度设备当前的编码器位置（`axis_pos_`）保存到Tango数据库的 `axis_pos` 属性中。

## 使用场景

1. **运动完成后保存位置**：在执行运动命令后，保存最终的编码器位置作为参考
2. **标定后保存**：完成设备标定后，保存标定位置
3. **定期备份**：定期保存当前位置作为系统状态备份
4. **故障恢复**：在系统重启后，可以从数据库读取上次保存的位置

## 实现原理

### 数据流程

```
运行时内存                    Tango数据库
┌─────────────────┐          ┌──────────────────┐
│  axis_pos_[6]   │          │  axis_pos        │
│  (double数组)   │  保存     │  (string数组)    │
│                 │  ────>   │                  │
│  实时编码器值    │          │  持久化存储       │
└─────────────────┘          └──────────────────┘
```

### 代码实现

#### 1. 头文件声明 (six_dof_device.h)

```cpp
// Database commands (NEW)
void saveEncoderPositions();     // 保存当前编码器值到数据库axis_pos属性
```

#### 2. 函数实现 (six_dof_device.cpp)

```cpp
void SixDofDevice::saveEncoderPositions() {
    INFO_STREAM << "[SaveEncoder] Saving current encoder positions to database..." << endl;
    
    try {
        // 首先更新编码器值
        update_axis_positions();
        
        // 准备属性数据
        std::vector<std::string> axis_pos_str;
        axis_pos_str.reserve(NUM_AXES);
        
        for (int i = 0; i < NUM_AXES; ++i) {
            axis_pos_str.push_back(std::to_string(axis_pos_[i]));
        }
        
        // 写入数据库
        Tango::DbData db_data;
        db_data.push_back(Tango::DbDatum("axis_pos"));
        db_data[0] << axis_pos_str;
        
        get_db_device()->put_property(db_data);
        
        // 记录日志
        std::ostringstream oss;
        oss << "Encoder positions saved: [";
        for (int i = 0; i < NUM_AXES; ++i) {
            if (i > 0) oss << ", ";
            oss << std::fixed << std::setprecision(3) << axis_pos_[i];
        }
        oss << "]";
        
        INFO_STREAM << "[SaveEncoder] " << oss.str() << endl;
        log_event(oss.str());
        
        result_value_ = 0; // Success
        
    } catch (const Tango::DevFailed &e) {
        ERROR_STREAM << "[SaveEncoder] Failed to save encoder positions: " << e.errors[0].desc << endl;
        result_value_ = 1; // Failure
        Tango::Except::re_throw_exception(e,
                                         "DATABASE_ERROR",
                                         "Failed to save encoder positions to database",
                                         "SixDofDevice::saveEncoderPositions()");
    }
}
```

#### 3. 命令注册

```cpp
// Database commands
command_list.push_back(new Tango::TemplCommand(
    "saveEncoderPositions", static_cast<void (Tango::DeviceImpl::*)()>(&SixDofDevice::saveEncoderPositions)));
```

## 使用方法

### Python示例

```python
import tango

# 连接设备
device = tango.DeviceProxy("sys/six_dof/1")

# 读取当前编码器位置
axis_pos = device.read_attribute("axisPos").value
print(f"当前位置: {axis_pos}")

# 保存到数据库
device.command_inout("saveEncoderPositions")
print("编码器位置已保存到数据库")

# 验证保存的数据
db = tango.Database()
saved_pos = db.get_device_property("sys/six_dof/1", "axis_pos")["axis_pos"]
print(f"数据库中的位置: {saved_pos}")
```

### C++示例

```cpp
#include <tango.h>

int main() {
    Tango::DeviceProxy* device = new Tango::DeviceProxy("sys/six_dof/1");
    
    // 读取当前编码器位置
    Tango::DeviceAttribute attr = device->read_attribute("axisPos");
    std::vector<double> axis_pos;
    attr >> axis_pos;
    
    // 保存到数据库
    device->command_inout("saveEncoderPositions");
    std::cout << "编码器位置已保存到数据库" << std::endl;
    
    delete device;
    return 0;
}
```

### GUI集成

在GUI中可以添加一个"保存位置"按钮：

```python
def on_save_position_clicked(self):
    """保存当前编码器位置按钮回调"""
    try:
        self.six_dof_device.command_inout("saveEncoderPositions")
        QMessageBox.information(self, "成功", "编码器位置已保存到数据库")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"保存失败: {str(e)}")
```

## 典型使用流程

### 1. 运动后保存

```python
# 执行运动
device.command_inout("movePoseAbsolute", [0, 0, 0, 0, 0, 0])

# 等待运动完成
while device.read_attribute("sdofState").value.any():
    time.sleep(0.1)

# 保存位置
device.command_inout("saveEncoderPositions")
```

### 2. 定期自动保存

```python
import time
import tango

device = tango.DeviceProxy("sys/six_dof/1")

while True:
    # 每10分钟保存一次
    time.sleep(600)
    try:
        device.command_inout("saveEncoderPositions")
        print(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] 位置已自动保存")
    except Exception as e:
        print(f"自动保存失败: {e}")
```

### 3. 系统启动时读取上次位置

```python
import tango

device_name = "sys/six_dof/1"
device = tango.DeviceProxy(device_name)
db = tango.Database()

# 读取上次保存的位置
saved_pos = db.get_device_property(device_name, "axis_pos")["axis_pos"]
print(f"上次保存的位置: {saved_pos}")

# 读取当前位置
current_pos = device.read_attribute("axisPos").value
print(f"当前编码器位置: {current_pos}")

# 可选：如果需要，移动到上次保存的位置
# device.command_inout("movePoseAbsolute", [float(p) for p in saved_pos])
```

## 数据库结构

### axis_pos 属性

- **类型**: DevVarStringArray (字符串数组)
- **长度**: 6 (对应6个轴)
- **单位**: mm
- **存储位置**: Tango数据库，设备属性表

### 数据格式示例

```json
{
  "axis_pos": [
    "421.485",
    "421.485",
    "421.485",
    "421.485",
    "421.485",
    "421.485"
  ]
}
```

## 测试方法

运行测试脚本：

```bash
python scripts/test_save_encoder_positions.py
```

测试脚本会：
1. 读取当前编码器位置
2. 调用 `saveEncoderPositions` 命令
3. 验证数据已正确保存到数据库
4. 对比内存值和数据库值的一致性

## 注意事项

1. **线程安全**：命令执行在Tango主线程，不会与其他命令冲突
2. **数据库连接**：需要Tango数据库服务正常运行
3. **权限要求**：需要对设备属性有写权限
4. **异常处理**：如果保存失败，会抛出异常并设置 `result_value_ = 1`
5. **日志记录**：每次保存都会记录到设备日志中

## 与历史数据记录的区别

| 特性 | saveEncoderPositions | Tango归档系统 (HDB++) |
|------|---------------------|----------------------|
| 触发方式 | 手动命令 | 自动定期 |
| 存储位置 | 设备属性 (property) | 历史数据库 |
| 数据量 | 单个值（覆盖） | 时间序列 |
| 用途 | 参考位置/备份 | 历史分析/趋势 |
| 查询方式 | `get_device_property` | 历史数据查询 |

两种方式可以同时使用，互为补充。

## 配置文件更新

在 `config/devices_config.json` 中已添加 `axis_pos` 字段：

```json
{
  "six_dof_1": {
    "props": {
      "axis_pos": ["0.0", "0.0", "0.0", "0.0", "0.0", "0.0"],
      ...
    }
  }
}
```

注册设备后，这个字段会成为数据库中的property，可以通过 `saveEncoderPositions` 命令动态更新。

## 相关文件

- 头文件: `include/device_services/six_dof_device.h`
- 实现文件: `src/device_services/six_dof_device.cpp`
- 配置文件: `config/devices_config.json`
- 测试脚本: `scripts/test_save_encoder_positions.py`
