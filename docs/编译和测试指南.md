# 编译和测试指南

## 编译步骤

### 1. 环境准备

#### Windows环境
```powershell
# 确保已安装：
# - Visual Studio 2019或更高版本（包含C++工具链）
# - CMake 3.16或更高版本
# - Tango开发库（如果使用Tango）

# 检查CMake版本
cmake --version
```

#### Linux/WSL环境
```bash
# 安装依赖
sudo apt-get update
sudo apt-get install -y \
    build-essential \
    cmake \
    libtango-dev \
    qtbase5-dev \
    python3-dev \
    python3-pip

# 安装Python依赖（用于测试）
pip3 install pytango pyqt5 pyqtgraph
```

### 2. 编译项目

#### 使用CMake（推荐）

```bash
# 创建构建目录
mkdir -p build
cd build

# 配置项目
cmake ..

# 编译（Linux/WSL）
make -j4

# 或编译特定目标
make vacuum_server

# Windows (Visual Studio)
cmake .. -G "Visual Studio 16 2019"
cmake --build . --config Release
```

#### 编译输出

编译成功后，可执行文件位于：
- Linux/WSL: `build/vacuum_server`
- Windows: `build/Release/vacuum_server.exe`

### 3. 编译检查清单

- [ ] CMake配置成功，无错误
- [ ] 所有源文件编译通过
- [ ] 链接成功，无未解析符号
- [ ] 生成可执行文件

## 测试步骤

### 1. 单元测试（模拟模式）

#### 使用MockPLCCommunication测试

```python
# 测试脚本：scripts/test_plc_communication.py
python scripts/test_plc_communication.py
```

#### 手动测试（模拟模式）

1. **配置模拟模式**
   ```json
   // config/devices_config.json
   {
     "vacuum_1": {
       "simulator_mode": true,
       "plc_ip": "192.168.1.100"
     }
   }
   ```

2. **启动设备服务器**
   ```bash
   python scripts/start_servers.py
   ```

3. **测试连接**
   ```python
   import tango
   device = tango.DeviceProxy("sys/vacuum/1")
   device.connectPLC()  # 应该成功（模拟模式）
   ```

### 2. 集成测试（真实PLC）

#### 准备工作

1. **网络配置**
   ```bash
   # 测试网络连通性
   ping 192.168.1.100
   
   # 测试端口（如果可用）
   telnet 192.168.1.100 102
   ```

2. **PLC配置**
   - 确认PLC IP地址：192.168.1.100
   - 确认PLC端口：102
   - 确认PLC已启用TCP/IP通信
   - 确认PLC程序已下载并运行

3. **设备配置**
   ```json
   // config/devices_config.json
   {
     "vacuum_1": {
       "simulator_mode": false,
       "plc_ip": "192.168.1.100",
       "plc_port": 102
     }
   }
   ```

#### 测试流程

1. **启动设备服务器**
   ```bash
   python scripts/start_servers.py
   ```

2. **测试PLC连接**
   ```python
   import tango
   device = tango.DeviceProxy("sys/vacuum/1")
   
   # 连接PLC
   device.connectPLC()
   
   # 检查连接状态
   # （需要根据实际实现添加状态检查属性）
   ```

3. **测试数据读取**
   ```python
   # 读取传感器数据
   gauge1 = device.read_attribute("vacuumGauge1").value
   print(f"真空规1: {gauge1}")
   
   # 读取泵状态
   pump_power = device.read_attribute("screwPumpPower").value
   print(f"螺杆泵上电: {pump_power}")
   ```

4. **测试数据写入**
   ```python
   # 测试写入操作（谨慎操作）
   # device.command_inout("setScrewPumpPower", True)
   ```

5. **测试命令**
   ```python
   # 模式切换
   device.command_inout("switchMode", 0)  # 自动模式
   
   # 一键操作（测试前确认安全）
   # device.command_inout("oneKeyVacuumStart")
   ```

### 3. GUI测试

#### 启动GUI

```bash
# 方法1：使用main_controller
python src/integrated_control/main_controller.py

# 方法2：直接运行GUI（如果支持）
python -m gui.main_window
```

#### GUI功能测试

1. **连接测试**
   - 打开真空系统页面
   - 点击"连接PLC"按钮
   - 检查PLC连接状态显示

2. **数据显示测试**
   - 检查系统状态显示
   - 检查传感器数据显示
   - 检查泵状态显示
   - 检查阀门状态显示

3. **趋势图测试**
   - 观察真空度趋势图
   - 检查数据更新是否正常

4. **控制测试**
   - 测试模式切换
   - 测试一键操作（谨慎）
   - 测试参数设置

## 联调步骤

### 阶段1：基础连接测试

1. **网络层测试**
   ```bash
   # 测试TCP连接
   telnet 192.168.1.100 102
   ```

2. **协议层测试**
   - 使用Wireshark抓包分析
   - 检查请求/响应格式
   - 验证数据字节序

3. **应用层测试**
   - 测试简单BOOL读取
   - 测试WORD读取
   - 逐步测试复杂数据类型

### 阶段2：功能测试

1. **读取功能**
   - 测试所有传感器数据读取
   - 测试所有状态数据读取
   - 验证数据准确性

2. **写入功能**
   - 测试控制命令（谨慎）
   - 测试参数设置
   - 验证写入结果

3. **批量操作**
   - 测试批量读取
   - 测试连续操作
   - 验证性能

### 阶段3：稳定性测试

1. **长时间运行**
   - 运行24小时以上
   - 监控内存使用
   - 检查是否有内存泄漏

2. **异常处理**
   - 测试网络断开
   - 测试PLC重启
   - 测试异常数据

3. **性能测试**
   - 测试更新频率
   - 测试响应时间
   - 测试并发操作

## 故障排查

### 编译问题

1. **找不到Tango头文件**
   ```bash
   # Linux: 安装Tango开发库
   sudo apt-get install libtango-dev
   
   # 检查Tango安装位置
   find /usr -name "tango.h"
   ```

2. **链接错误**
   ```bash
   # 检查库路径
   ldconfig -p | grep tango
   
   # 手动指定库路径（如果需要）
   export LD_LIBRARY_PATH=/usr/lib:$LD_LIBRARY_PATH
   ```

3. **网络库链接错误（Windows）**
   ```cmake
   # CMakeLists.txt中已自动配置
   # 如果仍有问题，检查ws2_32.lib是否可用
   ```

### 运行时问题

1. **PLC连接失败**
   - 检查IP地址和端口
   - 检查防火墙设置
   - 检查PLC是否允许TCP连接
   - 查看设备服务器日志

2. **数据读取失败**
   - 检查地址映射是否正确
   - 检查数据类型是否匹配
   - 使用Wireshark分析协议数据包

3. **GUI无法连接设备**
   - 检查Tango数据库配置
   - 检查设备服务器是否运行
   - 检查设备名称是否正确

### 调试技巧

1. **启用详细日志**
   ```cpp
   // 在代码中添加日志
   log_event("PLC连接尝试: " + plc_ip_);
   ```

2. **使用Tango工具**
   ```bash
   # 查看设备属性
   tango_admin --list-device sys/vacuum/1
   
   # 查看设备命令
   tango_admin --list-command sys/vacuum/1
   ```

3. **网络抓包**
   ```bash
   # 使用Wireshark或tcpdump
   tcpdump -i any -w plc_comm.pcap host 192.168.1.100
   ```

## 性能优化建议

1. **更新频率**
   - 当前GUI更新频率：1秒
   - 可根据需要调整（在`_start_timer`中）

2. **批量读取**
   - 实现批量读取减少网络请求
   - 优化`readMultiple`方法

3. **数据缓存**
   - 实现数据缓存机制
   - 减少不必要的PLC读取

4. **异步操作**
   - 使用异步I/O提高响应性
   - 避免阻塞主线程

## 测试报告模板

```markdown
# 测试报告

## 测试环境
- 日期: YYYY-MM-DD
- 测试人员: XXX
- PLC型号: Siemens S7-1200
- PLC IP: 192.168.1.100
- 软件版本: X.X.X

## 测试结果

### 连接测试
- [ ] TCP连接成功
- [ ] PLC通信正常
- [ ] 数据读取正常

### 功能测试
- [ ] 传感器数据读取
- [ ] 状态数据读取
- [ ] 控制命令执行
- [ ] 参数设置

### 稳定性测试
- [ ] 长时间运行（24小时）
- [ ] 异常恢复
- [ ] 性能指标

## 问题记录
1. 问题描述
2. 复现步骤
3. 解决方案

## 结论
测试通过/失败
```

## 下一步

1. **协议完善**
   - 根据实际OPU-CA协议文档完善实现
   - 添加协议版本协商
   - 实现数据包校验

2. **功能增强**
   - 自动重连机制
   - 连接健康检查
   - 性能监控

3. **文档完善**
   - API文档
   - 用户手册
   - 故障排查手册
