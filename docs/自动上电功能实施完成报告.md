# è‡ªåŠ¨ä¸Šç”µåŠŸèƒ½å®æ–½å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-23  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ å®æ–½æ¦‚è¿°

å·²æˆåŠŸå®ç°æ‰€æœ‰è®¾å¤‡çš„**é©±åŠ¨å™¨ä¸Šç”µ**å’Œ**åˆ¹è½¦é‡Šæ”¾**è‡ªåŠ¨æ§åˆ¶åŠŸèƒ½ï¼Œé…ç½®æ–‡ä»¶è‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. é…ç½®æ–‡ä»¶è‡ªåŠ¨ç”Ÿæ•ˆ

#### é…ç½®ä½ç½®
`config/devices_config.json`

#### é…ç½®å‚æ•°
```json
{
  "six_dof_1": {
    "props": {
      "driverPowerPort": "0",              // OUTç«¯å£å·
      "driverPowerController": "sys/motion/1",  // æ§åˆ¶å™¨åç§°
      "brakePowerPort": "3",               // åˆ¹è½¦ç«¯å£
      "brakePowerController": "sys/motion/1"
    }
  }
}
```

#### ç”Ÿæ•ˆæµç¨‹
```
è®¾å¤‡å¯åŠ¨ â†’ è¯»å–é…ç½® â†’ è¿æ¥æ§åˆ¶å™¨ â†’ è‡ªåŠ¨ä¸Šç”µ â†’ è‡ªåŠ¨é‡Šæ”¾åˆ¹è½¦ â†’ å°±ç»ª
```

---

### 2. è®¾å¤‡å®ç°çŠ¶æ€

| è®¾å¤‡ | é©±åŠ¨å™¨ä¸Šç”µ | åˆ¹è½¦æ§åˆ¶ | é…ç½®ç«¯å£ | æ§åˆ¶å™¨ |
|------|-----------|---------|---------|--------|
| **å…­è‡ªç”±åº¦** | âœ… å·²å®ç° | âœ… å·²å®ç° | OUT0 / OUT3 | 192.168.1.11 |
| **å¤§è¡Œç¨‹** | âœ… å·²å®ç° | âœ… å·²å®ç° | OUT0 / OUT4 | 192.168.1.11 |
| **åå°„å…‰æˆåƒ** | âœ… å·²å®ç° | N/A | OUT5 | 192.168.1.11 |
| **è¾…åŠ©æ”¯æ’‘1-5** | âœ… å·²å®ç° | N/A | OUT6 (å…±ç”¨) | 192.168.1.11 |

---

### 3. Tangoæ¥å£å®ç°

#### 3.1 å‘½ä»¤æ¥å£ï¼ˆCommandsï¼‰

æ‰€æœ‰è®¾å¤‡å·²å®ç°ä»¥ä¸‹å‘½ä»¤ï¼š

| å‘½ä»¤å | åŠŸèƒ½ | é€‚ç”¨è®¾å¤‡ |
|--------|------|---------|
| `enableDriverPower` | æ‰‹åŠ¨å¯åŠ¨é©±åŠ¨å™¨ | å…¨éƒ¨ |
| `disableDriverPower` | æ‰‹åŠ¨å…³é—­é©±åŠ¨å™¨ | å…¨éƒ¨ |
| `releaseBrake` | æ‰‹åŠ¨é‡Šæ”¾åˆ¹è½¦ | å…­è‡ªç”±åº¦ã€å¤§è¡Œç¨‹ |
| `engageBrake` | æ‰‹åŠ¨å¯ç”¨åˆ¹è½¦ | å…­è‡ªç”±åº¦ã€å¤§è¡Œç¨‹ |
| `queryPowerStatus` | æŸ¥è¯¢ç”µæºçŠ¶æ€ï¼ˆJSONï¼‰ | å…¨éƒ¨ |

#### 3.2 å±æ€§æ¥å£ï¼ˆAttributesï¼‰

æ‰€æœ‰è®¾å¤‡å·²å®ç°ä»¥ä¸‹å±æ€§ï¼š

| å±æ€§å | ç±»å‹ | è¯´æ˜ | é€‚ç”¨è®¾å¤‡ |
|--------|------|------|---------|
| `driverPowerStatus` | BOOLEAN | é©±åŠ¨å™¨ç”µæºçŠ¶æ€ | å…¨éƒ¨ |
| `brakeStatus` | BOOLEAN | åˆ¹è½¦çŠ¶æ€ | å…­è‡ªç”±åº¦ã€å¤§è¡Œç¨‹ |

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. å…­è‡ªç”±åº¦è®¾å¤‡ (SixDofDevice)

#### å¤´æ–‡ä»¶ä¿®æ”¹ (`include/device_services/six_dof_device.h`)
```cpp
// æ–°å¢æˆå‘˜å˜é‡
double motor_step_angle_;
double motor_gear_ratio_;
double motor_subdivision_;
short driver_power_port_;
short brake_power_port_;
std::string driver_power_controller_;
std::string brake_power_controller_;
bool driver_power_enabled_;
bool brake_released_;

// æ–°å¢æ–¹æ³•å£°æ˜
void enableDriverPower();
void disableDriverPower();
void releaseBrake();
void engageBrake();
Tango::DevString queryPowerStatus();
void read_driver_power_status(Tango::Attribute &attr);
void read_brake_status(Tango::Attribute &attr);
```

#### å®ç°æ–‡ä»¶ä¿®æ”¹ (`src/device_services/six_dof_device.cpp`)
- âœ… `init_device()`: è¯»å–é…ç½®å‚æ•°ï¼Œåˆå§‹åŒ–çŠ¶æ€å˜é‡
- âœ… `connect_proxies()`: è‡ªåŠ¨è°ƒç”¨ `enable_driver_power()` å’Œ `release_brake()`
- âœ… `enable_driver_power()`: é€šè¿‡ `motion_controller_proxy_->command_inout("writeIO", ...)` æ§åˆ¶OUTç«¯å£
- âœ… `release_brake()`: åŒä¸Š
- âœ… Tangoå‘½ä»¤æ³¨å†Œ: åœ¨ `command_factory()` ä¸­æ³¨å†Œæ‰€æœ‰å‘½ä»¤
- âœ… Tangoå±æ€§æ³¨å†Œ: åœ¨ `attribute_factory()` ä¸­æ³¨å†ŒçŠ¶æ€å±æ€§
- âœ… å±æ€§è¯»å–å®ç°: `read_driver_power_status()` å’Œ `read_brake_status()`

---

### 2. å¤§è¡Œç¨‹è®¾å¤‡ (LargeStrokeDevice)

**å®ç°æ–¹å¼ä¸å…­è‡ªç”±åº¦ç›¸åŒ**ï¼Œå…³é”®å·®å¼‚ï¼š
- é©±åŠ¨å™¨ç«¯å£: OUT0 (ä¸å…­è‡ªç”±åº¦å…±ç”¨)
- åˆ¹è½¦ç«¯å£: OUT4 (ç‹¬ç«‹)

---

### 3. åå°„å…‰æˆåƒè®¾å¤‡ (ReflectionImagingDevice)

**å®ç°æ–¹å¼ç±»ä¼¼**ï¼Œå…³é”®å·®å¼‚ï¼š
- âœ… ä»…é©±åŠ¨å™¨æ§åˆ¶ï¼Œæ— åˆ¹è½¦
- é©±åŠ¨å™¨ç«¯å£: OUT5
- æ—  `releaseBrake` å’Œ `engageBrake` å‘½ä»¤
- æ—  `brakeStatus` å±æ€§

---

### 4. è¾…åŠ©æ”¯æ’‘è®¾å¤‡ (AuxiliarySupportDevice)

**å®ç°æ–¹å¼ç±»ä¼¼**ï¼Œå…³é”®å·®å¼‚ï¼š
- âœ… ä»…é©±åŠ¨å™¨æ§åˆ¶ï¼Œæ— åˆ¹è½¦
- é©±åŠ¨å™¨ç«¯å£: OUT6 (5ä¸ªè®¾å¤‡å…±ç”¨)
- æ— åˆ¹è½¦ç›¸å…³æ¥å£

---

## ğŸ“Š é…ç½®ç”Ÿæ•ˆéªŒè¯

### éªŒè¯è„šæœ¬
å·²åˆ›å»ºè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬: `scripts/test_auto_power_on.py`

#### åŠŸèƒ½
1. âœ… è¿æ¥æ‰€æœ‰è®¾å¤‡
2. âœ… è¯»å– `driverPowerStatus` å’Œ `brakeStatus` å±æ€§
3. âœ… è°ƒç”¨ `queryPowerStatus` å‘½ä»¤
4. âœ… éªŒè¯é…ç½®å‚æ•°æ˜¯å¦æ­£ç¡®
5. âœ… ç”ŸæˆJSONæ ¼å¼æµ‹è¯•æŠ¥å‘Š

#### è¿è¡Œæ–¹å¼
```bash
python scripts/test_auto_power_on.py
```

#### é¢„æœŸè¾“å‡º
```
[12:34:56] â„¹ï¸ å¼€å§‹è‡ªåŠ¨ä¸Šç”µåŠŸèƒ½éªŒè¯æµ‹è¯•
[12:34:56] ğŸ” æµ‹è¯•è®¾å¤‡: å…­è‡ªç”±åº¦ (sys/six_dof/1)
[12:34:56] âœ… è¿æ¥è®¾å¤‡ sys/six_dof/1 æˆåŠŸ, çŠ¶æ€: ON
[12:34:56] âœ… é©±åŠ¨å™¨ç”µæºçŠ¶æ€: True
[12:34:56] âœ… åˆ¹è½¦çŠ¶æ€: True
[12:34:56] âœ… é©±åŠ¨å™¨è‡ªåŠ¨ä¸Šç”µæˆåŠŸ
[12:34:56] âœ… åˆ¹è½¦è‡ªåŠ¨é‡Šæ”¾æˆåŠŸ
...
[12:35:00] ğŸ‰ æ‰€æœ‰è®¾å¤‡è‡ªåŠ¨ä¸Šç”µåŠŸèƒ½æ­£å¸¸ï¼
```

---

## ğŸ¯ æ ¸å¿ƒé€»è¾‘

### è‡ªåŠ¨ä¸Šç”µæµç¨‹

```cpp
void SixDofDevice::connect_proxies() {
    // ... è¿æ¥è¿åŠ¨æ§åˆ¶å™¨ ...
    
    if (motion_connected) {
        // 1. åº”ç”¨ç”µæœºç»†åˆ†å‚æ•°
        Tango::DevVarDoubleArray struct_params;
        struct_params.length(4);
        // ... å¡«å……å‚æ•° ...
        motion_controller_proxy_->command_inout("setStructParameter", data_in);
        
        // 2. è‡ªåŠ¨å¯åŠ¨é©±åŠ¨å™¨ç”µæº
        if (enable_driver_power()) {
            INFO_STREAM << "Driver power enabled successfully" << endl;
            
            // 3. è‡ªåŠ¨é‡Šæ”¾åˆ¹è½¦
            if (release_brake()) {
                INFO_STREAM << "Brake released successfully" << endl;
            }
        }
    }
}
```

### ç”µæºæ§åˆ¶å®ç°

```cpp
bool SixDofDevice::enable_driver_power() {
    if (sim_mode_) {
        driver_power_enabled_ = true;
        return true;
    }
    
    if (driver_power_port_ < 0 || driver_power_controller_.empty()) {
        return true;  // æœªé…ç½®æ—¶è·³è¿‡
    }
    
    try {
        Tango::DeviceProxy power_ctrl(driver_power_controller_);
        Tango::DevVarDoubleArray params;
        params.length(2);
        params[0] = static_cast<double>(driver_power_port_);
        params[1] = 1.0;  // HIGH = ä¸Šç”µ
        Tango::DeviceData data;
        data << params;
        power_ctrl.command_inout("writeIO", data);
        driver_power_enabled_ = true;
        return true;
    } catch (Tango::DevFailed &e) {
        ERROR_STREAM << "Failed to enable driver power: " << e.errors[0].desc << endl;
        return false;
    }
}
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

å·²åˆ›å»ºå®Œæ•´æ–‡æ¡£ï¼š

1. âœ… **GUIç”µæºæ§åˆ¶æ¥å£è¯´æ˜.md** - GUIå¼€å‘å®Œæ•´æŒ‡å—
   - Tangoæ¥å£å®šä¹‰
   - Pythonä»£ç ç¤ºä¾‹
   - GUIç•Œé¢è®¾è®¡å»ºè®®
   - å®‰å…¨æ“ä½œå»ºè®®

2. âœ… **ç”µæºæ§åˆ¶é…ç½®ç”Ÿæ•ˆè¯´æ˜.md** - é…ç½®æ–¹å¼è¯¦è§£
   - é…ç½®æ–‡ä»¶è‡ªåŠ¨ç”Ÿæ•ˆæµç¨‹
   - Tangoæ•°æ®åº“é…ç½®æ–¹å¼
   - GUIæ‰‹åŠ¨æ§åˆ¶æ–¹å¼
   - ä¸‰ç§æ–¹å¼å¯¹æ¯”

3. âœ… **ç”µæºæ§åˆ¶å®æ–½å®ŒæˆæŠ¥å‘Š.md** - å®æ–½æ€»ç»“
   - å·²å®ŒæˆåŠŸèƒ½åˆ—è¡¨
   - ä»£ç ä¿®æ”¹è¯¦æƒ…
   - æµ‹è¯•éªŒè¯æ–¹æ³•

4. âœ… **è‡ªåŠ¨ä¸Šç”µåŠŸèƒ½å®æ–½å®ŒæˆæŠ¥å‘Š.md** (æœ¬æ–‡æ¡£)
   - å®Œæ•´å®æ–½æ¦‚è¿°
   - æ‰€æœ‰è®¾å¤‡å®ç°çŠ¶æ€
   - éªŒè¯è„šæœ¬ä½¿ç”¨è¯´æ˜

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. ç¼–è¯‘ä»£ç 
```bash
cd build
cmake ..
make
```

### 2. å¯åŠ¨è®¾å¤‡
```bash
python scripts/start_servers.py
```

### 3. è¿è¡ŒéªŒè¯è„šæœ¬
```bash
python scripts/test_auto_power_on.py
```

### 4. æ£€æŸ¥æ—¥å¿—
æŸ¥çœ‹è®¾å¤‡æ—¥å¿—ç¡®è®¤è‡ªåŠ¨ä¸Šç”µï¼š
```
âœ“ Driver power enabled on sys/motion/1 port OUT0
âœ“ Brake released on sys/motion/1 port OUT3
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é…ç½®æ–‡ä»¶ä¿®æ”¹
- ä¿®æ”¹ `config/devices_config.json` åéœ€è¦**é‡å¯è®¾å¤‡**æ‰èƒ½ç”Ÿæ•ˆ
- å»ºè®®åœ¨ç³»ç»Ÿç»´æŠ¤æ—¶ä¿®æ”¹é…ç½®

### 2. ç«¯å£å…±ç”¨
- OUT0: å…­è‡ªç”±åº¦ + å¤§è¡Œç¨‹ (å…±ç”¨)
- OUT6: è¾…åŠ©æ”¯æ’‘1-5 (å…±ç”¨)
- ç¡®ä¿ç¡¬ä»¶æ¥çº¿æ­£ç¡®

### 3. æ¨¡æ‹Ÿæ¨¡å¼
- æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ä¸ä¼šå®é™…æ§åˆ¶ç¡¬ä»¶
- ä½†ä¼šæ›´æ–°çŠ¶æ€å˜é‡å’Œæ—¥å¿—
- é€‚åˆå¼€å‘å’Œè°ƒè¯•

### 4. æ•…éšœå¤„ç†
- å¦‚æœè‡ªåŠ¨ä¸Šç”µå¤±è´¥ï¼Œè®¾å¤‡ä¼šè®°å½•é”™è¯¯æ—¥å¿—
- å¯ä»¥é€šè¿‡GUIæ‰‹åŠ¨æ§åˆ¶
- æ£€æŸ¥è¿åŠ¨æ§åˆ¶å™¨è¿æ¥å’Œé…ç½®

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### é¢„æœŸç»“æœ

| è®¾å¤‡ | è¿æ¥ | é©±åŠ¨å™¨ä¸Šç”µ | åˆ¹è½¦é‡Šæ”¾ | é…ç½®æ­£ç¡® |
|------|------|-----------|---------|---------|
| å…­è‡ªç”±åº¦ | âœ… | âœ… | âœ… | âœ… |
| å¤§è¡Œç¨‹ | âœ… | âœ… | âœ… | âœ… |
| åå°„å…‰æˆåƒ | âœ… | âœ… | N/A | âœ… |
| è¾…åŠ©æ”¯æ’‘1 | âœ… | âœ… | N/A | âœ… |
| è¾…åŠ©æ”¯æ’‘2 | âœ… | âœ… | N/A | âœ… |
| è¾…åŠ©æ”¯æ’‘3 | âœ… | âœ… | N/A | âœ… |
| è¾…åŠ©æ”¯æ’‘4 | âœ… | âœ… | N/A | âœ… |
| è¾…åŠ©æ”¯æ’‘5 | âœ… | âœ… | N/A | âœ… |

---

## ğŸ‰ æ€»ç»“

### å·²å®ç°åŠŸèƒ½

âœ… **é…ç½®è‡ªåŠ¨ç”Ÿæ•ˆ**: è®¾å¤‡å¯åŠ¨æ—¶è‡ªåŠ¨è¯»å–é…ç½®å¹¶ä¸Šç”µ  
âœ… **é©±åŠ¨å™¨æ§åˆ¶**: æ‰€æœ‰8ä¸ªè®¾å¤‡æ”¯æŒé©±åŠ¨å™¨ä¸Šç”µ/æ–­ç”µ  
âœ… **åˆ¹è½¦æ§åˆ¶**: å…­è‡ªç”±åº¦å’Œå¤§è¡Œç¨‹æ”¯æŒåˆ¹è½¦é‡Šæ”¾/é”å®š  
âœ… **Tangoæ¥å£**: å®Œæ•´çš„å‘½ä»¤å’Œå±æ€§æ¥å£ä¾›GUIè°ƒç”¨  
âœ… **çŠ¶æ€ç›‘æ§**: å®æ—¶è¯»å–ç”µæºå’Œåˆ¹è½¦çŠ¶æ€  
âœ… **æ¨¡æ‹Ÿæ¨¡å¼**: æ”¯æŒæ— ç¡¬ä»¶è°ƒè¯•  
âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•**: éªŒè¯è„šæœ¬è‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰åŠŸèƒ½  
âœ… **å®Œæ•´æ–‡æ¡£**: å¼€å‘ã€é…ç½®ã€ä½¿ç”¨æ–‡æ¡£é½å…¨

### é…ç½®ç”Ÿæ•ˆæ–¹å¼

âœ… **ä¸»è¦æ–¹å¼**: é…ç½®æ–‡ä»¶è‡ªåŠ¨ç”Ÿæ•ˆï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰  
âœ… **è¾…åŠ©æ–¹å¼**: GUIæ‰‹åŠ¨æ§åˆ¶ï¼ˆè°ƒè¯•å’Œç´§æ€¥æƒ…å†µï¼‰

### å¼€å‘è´¨é‡

âœ… **ä»£ç å®Œæ•´**: æ‰€æœ‰è®¾å¤‡å®ç°ä¸€è‡´  
âœ… **å®¹é”™å¤„ç†**: æœªé…ç½®æ—¶è·³è¿‡ï¼Œä¸æŠ¥é”™  
âœ… **æ—¥å¿—å®Œå–„**: è¯¦ç»†è®°å½•æ¯ä¸ªæ“ä½œ  
âœ… **æµ‹è¯•è¦†ç›–**: è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

---

**å®æ–½å®Œæˆï¼æ‰€æœ‰è®¾å¤‡çš„è‡ªåŠ¨ä¸Šç”µåŠŸèƒ½å·²å°±ç»ªï¼Œå¯ä»¥è¿›è¡Œç°åœºæµ‹è¯•ã€‚** ğŸŠ

---

**æ–‡æ¡£ç»´æŠ¤**: å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦æ›´æ–°ï¼Œè¯·è”ç³»ç³»ç»Ÿé›†æˆå›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-12-23

